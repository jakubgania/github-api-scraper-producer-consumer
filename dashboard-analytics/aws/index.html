<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/6.0.0/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
  </head>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    #data {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
      white-space: pre-wrap;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1 class="text-4xl font-bold pb-2">
    Dashboard
  </h1>

  <p id="nextUpdate" class="text-sm text-gray-500 mt-2 mb-2">
    Next update in 60s
  </p>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Inserted items</p>
      <p id="totalInsertedItems" class="text-6xl font-semibold font-mono">--</p>
    </div>
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Total Requests</p>
      <p id="totalProcessedItems" class="text-6xl font-semibold font-mono">--</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Total Requests</p>
      <p id="totalRequests" class="text-6xl font-semibold font-mono">--</p>
    </div>
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Requests Last Minute</p>
      <p id="requestsLastMinute" class="text-6xl font-semibold font-mono">--</p>
    </div>
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Workers</p>
      <p id="workersCount" class="text-6xl font-semibold font-mono">--</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Next Milestone</p>
      <p id="nextMilestoneTarget" class="text-2xl font-semibold font-mono">--</p>
    </div>
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Minutes Needed</p>
      <p id="nextMilestoneMinutesNeeded" class="text-2xl font-semibold font-mono">--</p>
    </div>
    <div class="p-4 rounded-xl bg-slate-100">
      <p class="text-sm text-gray-500 mb-1">Estimated time of arrival</p>
      <p id="nextMilestoneEta" class="text-2xl font-semibold font-mono">--</p>
    </div>
  </div>

  <!-- Added and skipped items metrics -->
  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">Added / Skipped Metrics</h2>
    <div id="addedAndSkippedChart" class="w-full" style="height: 380px;"></div>
  </div>

  <!-- Requests Metrics -->
  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">Requests Metrics</h2>
    <div id="requestsChart" class="w-full" style="height: 380px;"></div>
  </div>

  <!-- Toggle for 12/24 Hours -->
  <div class="mb-6">
    <button id="toggle12h24h" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Show 12 Hours</button>
  </div>

  <!-- 12/24h Request Metrics (Line Only) -->
  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">12/24 Hours Requests</h2>
    <div id="chart12h24" class="w-full" style="height: 380px;"></div>
  </div>

  <!-- 24h Requests per Hour (Bar and Line) -->
  <div class="mb-6">
    <button id="toggleStyle24h" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Switch to Line</button>
    <h2 class="text-xl font-bold mb-2">Requests per Hour (24h)</h2>
    <div id="chart24h" class="w-full" style="height: 380px;"></div>
  </div>

  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">Workers</h2>
    <div class="overflow-x-auto rounded-lg shadow bg-white">
      <table class="w-full text-left border-collapse">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Container ID</th>
            <th class="px-4 py-2">Start Time</th>
            <th class="px-4 py-2">Uptime</th>
            <th class="px-4 py-2">Processed</th>
          </tr>
        </thead>
        <tbody id="workersTable">
          <tr>
            <td colspan="4" class="px-4 py-2 text-gray-500 text-center">No data</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">Raw data</h2>
    <button id="toggleRaw" class="mb-2 text-sm text-blue-600 hover:underline">
      Show raw data
    </button>
    <div id="data" class="p-4 border border-gray-300 rounded bg-gray-50 font-mono text-sm hidden">
      Loading data...
    </div>
  </div>

  <!-- <h2 class="text-xl font-bold mb-2">Raw data</h2> -->
  <!-- <div id="data">Loading data...</div> -->

  <script>
    let dataMinutes = [];
    let dataHours = [];
    let data12h24h = [];
    let currentMode = "minutes";
    let currentStyle24h = "bar";
    let toggle12h24hValue = "12";  // Start with 12 hours

    let countdown = 60;

    let addedAndSkippedChart = echarts.init(document.getElementById("addedAndSkippedChart"));
    let chartRequests = echarts.init(document.getElementById("requestsChart"));
    let chart12h24 = echarts.init(document.getElementById("chart12h24"));
    let chart24h = echarts.init(document.getElementById("chart24h"));

    function updateCountdown() {
      document.getElementById("nextUpdate").textContent = `Next update in ${countdown}s`;
    }

    function tickCountdown() {
      if (countdown > 0) {
        countdown--;
        updateCountdown();
      }
    }

    function formatTimestamp(ts) {
      let date;
      if (!isNaN(ts)) {
        const num = Number(ts);
        date = new Date(num < 1e12 ? num * 1000 : num);
      } else {
        date = new Date(ts);
      }
      return dateFns.format(date, "yyyy-MM-dd HH:mm:ss");
    }

    function formatRelative(ts) {
      let date;
      if (!isNaN(ts)) {
        const num = Number(ts);
        date = new Date(num < 1e12 ? num * 1000 : num);
      } else {
        date = new Date(ts);
      }
      return dateFns.formatDistanceToNow(date, { addSuffix: true });
    }

    function renderAddedAndSkippedChart(data) {
      const times = data.map(d => dateFns.format(new Date(d.timestamp), "HH:mm"));
      const inserted = data.map(d => d.inserted);
      const skipped = data.map(d => d.skipped);

      const option = {
        tooltip: { trigger: "axis" },
        legend: { data: ["Inserted", "Skipped"] },
        grid: {
          left: '0%',
          right: '0%',
          top: '8%',
          bottom: '10%',
          containLabel: true,
        },
        xAxis: {
          type: "category",
          data: times,
          axisLabel: { rotate: 45 }
        },
        yAxis: { type: "value" },
        series: [
          {
            name: "Inserted",
            type: "line",
            // smooth: true,
            showSymbol: false,
            data: inserted,
            itemStyle: { color: "#2bff60" }
          },
          {
            name: "Skipped",
            type: "line",
            // smooth: true,
            showSymbol: false,
            data: skipped,
            itemStyle: { color: "#842bff" }
          }
        ]
      };

      addedAndSkippedChart.setOption(option);
    }

    let requestsChart;
    function initChart() {
      const chartDom = document.getElementById("requestsChart");
      requestsChart = echarts.init(chartDom);
    }
    function updateChart(metrics) {
      if (!requestsChart) {
        initChart();
      }
      const times = metrics.map(m => dateFns.format(new Date(m.timestamp), "HH:mm"));
      const counts = metrics.map(m => m.requests_count);

      const option = {
        tooltip: { trigger: "axis" },
        grid: {
          left: '0%',
          right: '0%',
          top: '8%',
          bottom: '10%',
          containLabel: true,
        },
        xAxis: {
          type: "category",
          data: times,
          boundaryGap: true,
          axisLabel: { rotate: 45 }
        },
        yAxis: {
          type: 'value',
          // min: 0,
          // max: (val) => Math.ceil(val.max / 10) * 10 + 10,
          // interval: 20,
        },
        series: [
          {
            name: "Requests per Minute",
            type: "bar",
            data: counts,
            itemStyle: {
              color: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                  { offset: 0, color: '#3399ff' },
                  { offset: 1, color: '#66ccff' }
                ]
              }
            },
            barCategoryGap: '10%',
          }
        ]
      };
      requestsChart.setOption(option);
      requestsChart.resize();
    }

    // Update the chart with 12/24 hours request metrics (Line only)
    function render12h24Chart(data) {
      const times = data.map(d => dateFns.format(new Date(d.timestamp), "HH:mm"));
      const counts = data.map(d => d.requests_count);

      const option = {
        tooltip: { trigger: "axis" },
        grid: { left: '0%', right: '0%', top: '8%', bottom: '10%', containLabel: true },
        xAxis: {
          type: "category",
          data: times,
          axisLabel: { 
            rotate: 45,
            formatter: function (value) {
              const [hour, minute] = value.split(":");
              if (minute === "00") {
                return value;
              }
              return "";
            }
          }
        },
        yAxis: { type: "value" },
        series: [{
          type: "line",
          data: counts,
          smooth: true,
          showSymbol: false,
          itemStyle: { color: "#3399ff" }
        }]
      };
      chart12h24.setOption(option);
    }

    // let chart24h = echarts.init(document.getElementById("chart24h"));
    // let currentMode = "minutes";
    let currentStyle = "bar";

     document.getElementById("toggleStyle24h").addEventListener("click", () => {
      currentStyle24h = currentStyle24h === "bar" ? "line" : "bar";

      console.log("currentStyle24h after toggle:", currentStyle24h);
      
      document.getElementById("toggleStyle24h").textContent = currentStyle24h === "bar" ? "Switch to Line" : "Switch to Bar";
      
      render24hChart(dataHours, currentStyle24h);
    });



    function render24hChart(data, chartType) {
      console.log("Rendering chart with type:", chartType); 
      const times = data.map(d => dateFns.format(new Date(d.timestamp), "HH:mm"));
      const counts = data.map(d => d.requests_count);

      const option = {
        tooltip: { trigger: "axis" },
        grid: {
          left: '0%',
          right: '0%',
          top: '8%',
          bottom: '10%',
          containLabel: true,
        },
        xAxis: {
          type: "category",
          data: times,
          boundaryGap: true,
          axisLabel: {
            rotate: 45,
          },
          // splitLine: { show: false },
          // axisTick: { show: false },
        },
        yAxis: {
          type: "value",
          // splitLine: { show: false },
        },
        series: [
          {
            type: chartType,
            data: counts,
            smooth: chartType === "line",
            showSymbol: false,
            barCategoryGap: "8%",
            itemStyle: {
              color: "#3399ff"
            }
          }
        ]
      };

      chart24h.setOption(option);
    }

    // // Toggle style for 24h chart (bar/line)
    // document.getElementById("toggleStyle24h").addEventListener("click", () => {
    //   currentStyle24h = currentStyle24h === "bar" ? "line" : "bar";  // Zmiana typu wykresu
    //   document.getElementById("toggleStyle24h").textContent = currentStyle24h === "bar" ? "Switch to Line" : "Switch to Bar";
      
    //   render24hChart(dataHours, currentStyle24h); // Przekazanie typu wykresu
    // });

    // Function to filter data for 12 or 24 hours
    function filterDataForLastHours(data, hours) {
      const now = new Date();
      const timeLimit = now.setHours(now.getHours() - hours); // Subtract hours from current time
      return data.filter(d => new Date(d.timestamp) >= timeLimit);
    }

    async function loadData() {
      try {
        const response = await fetch("data.json", { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const json = await response.json();

        dataMinutes = json.requests_24h_minute || [];
        data12h24h = json.requests_24h_minute || [];
        dataHours = json.requests_24h_hour || [];

        countdown = 60;
        updateCountdown();

        document.getElementById("data").textContent = JSON.stringify(json, null, 2);

        document.getElementById("totalInsertedItems").textContent = json.ingest_totals["inserted"] ?? "--";
        document.getElementById("totalProcessedItems").textContent = json.ingest_totals["processed"] ?? "--";
        document.getElementById("totalRequests").textContent = json.total_requests ?? "--";
        document.getElementById("requestsLastMinute").textContent = json.requests_last_minute ?? "--";
        document.getElementById("workersCount").textContent = json.workers?.length ?? 0;

        document.getElementById("nextMilestoneTarget").textContent = json.next_milestone["target"] ?? "--";
        const minutes = json.next_milestone["minutes_needed"] ?? null;

        document.getElementById("nextMilestoneMinutesNeeded").textContent = minutes !== null ? minutes.toFixed(1) : "--";
        const eta = json.next_milestone["estimated_time_of_arrival"] ?? null;

        document.getElementById("nextMilestoneEta").textContent =
          eta !== null 
            ? new Date(eta).toLocaleString("en-GB", { 
                dateStyle: "medium", 
                timeStyle: "short", 
                timeZone: "Europe/Berlin"
              })
            : "--";

        const workersTable = document.getElementById("workersTable");
        workersTable.innerHTML = "";

        if (json.workers && json.workers.length > 0) {
          json.workers.forEach((worker, index) => {
            const row = document.createElement("tr");

            const isLast = index === json.workers.length - 1;
            row.className = isLast ? "" : "border-b border-slate-200";

            row.innerHTML = `
              <td class="px-4 py-2">
                <span class="inline-block w-3 h-3 bg-green-500 rounded-full"></span>
              </td>
              <td class="px-4 py-2 font-mono">${worker.container_id}</td>
              <td class="px-4 py-2">${formatTimestamp(worker.start_time)}</td>
              <td class="px-4 py-2 text-gray-600">${formatRelative(worker.start_time)}</td>
              <td class="px-4 py-2 font-mono">${worker.processed}</td>
            `;
            workersTable.appendChild(row);
          });
        } else {
          workersTable.innerHTML = `
            <tr>
              <td colspan="4" class="px-4 py-2 text-gray-500 text-center">No workers</td>
            </tr>
          `;
        }

        if (json.requests_metrics) {
          updateChart(json.requests_metrics);
        }

        if (json.requests_24h_minute) {
          // Filter data for last 12 or 24 hours
          const filtered12h24hData = filterDataForLastHours(data12h24h, toggle12h24hValue === "12" ? 12 : 24);
          render12h24Chart(filtered12h24hData);
        }

        if (json.requests_24h_hour) {
          render24hChart(dataHours, currentStyle24h);
        }

        if (json.ingest_60min) {
          console.log("ingest_60min", json.ingest_60min); // 👀 debug

          renderAddedAndSkippedChart(json.ingest_60min);
        } else {
          renderAddedAndSkippedChart([]);
        }
      } catch (err) {
        document.getElementById("data").textContent = "Error loading data: " + err;
      }
    }

    loadData();
    
    setInterval(loadData, 60000);
    setInterval(tickCountdown, 1000);
    window.addEventListener("resize", () => {
      if (addedAndSkippedChart) addedAndSkippedChart.resize();
      if (requestsChart) requestsChart.resize();
      if (chart12h24) chart12h24.resize();
      if (chart24h) chart24h.resize();
    });

     // Toggle between 12h and 24h
    document.getElementById("toggle12h24h").addEventListener("click", () => {
      toggle12h24hValue = toggle12h24hValue === "12" ? "24" : "12";
      document.getElementById("toggle12h24h").textContent = toggle12h24hValue === "12" ? "Show 24 Hours" : "Show 12 Hours";
      const filtered12h24hData = filterDataForLastHours(data12h24h, toggle12h24hValue === "12" ? 12 : 24);
      render12h24Chart(filtered12h24hData); // Render filtered data
    });

    const toggleRawBtn = document.getElementById("toggleRaw");
    const dataBox = document.getElementById("data");

    toggleRawBtn.addEventListener("click", () => {
      const isHidden = dataBox.classList.contains("hidden");
      if (isHidden) {
        dataBox.classList.remove("hidden");
        toggleRawBtn.textContent = "Hide raw data";
      } else {
        dataBox.classList.add("hidden");
        toggleRawBtn.textContent = "Show raw data";
      }
    });
  </script>
</body>
</html>