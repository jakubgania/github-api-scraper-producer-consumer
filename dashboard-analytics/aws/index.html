<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/6.0.0/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
  </head>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    #data {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
      white-space: pre-wrap;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1 class="text-4xl font-bold pb-2">
    Dashboard
  </h1>

  <p id="nextUpdate" class="text-sm text-gray-500 mt-2 mb-2">
    Next update in 60s
  </p>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-xl shadow-md bg-white">
      <p class="text-sm text-gray-500 mb-1">Total Requests</p>
      <p id="totalRequests" class="text-6xl font-semibold font-mono">--</p>
    </div>
    <div class="p-4 rounded-xl shadow-md bg-white">
      <p class="text-sm text-gray-500 mb-1">Requests Last Minute</p>
      <p id="requestsLastMinute" class="text-6xl font-semibold font-mono">--</p>
    </div>
    <div class="p-4 rounded-xl shadow-md bg-white">
      <p class="text-sm text-gray-500 mb-1">Workers</p>
      <p id="workersCount" class="text-6xl font-semibold font-mono">--</p>
    </div>
  </div>

  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">Requests Metrics</h2>
    <div id="requestsChart" class="w-full" style="height: 380px;"></div>
  </div>

  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">Workers</h2>
    <div class="overflow-x-auto rounded-lg shadow bg-white">
      <table class="w-full text-left border-collapse">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Container ID</th>
            <th class="px-4 py-2">Start Time</th>
            <th class="px-4 py-2">Uptime</th>
          </tr>
        </thead>
        <tbody id="workersTable">
          <tr>
            <td colspan="4" class="px-4 py-2 text-gray-500 text-center">No data</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="mb-6">
    <h2 class="text-xl font-bold mb-2">Raw data</h2>
    <button id="toggleRaw" class="mb-2 text-sm text-blue-600 hover:underline">
      Show raw data
    </button>
    <div id="data" class="p-4 border border-gray-300 rounded bg-gray-50 font-mono text-sm hidden">
      Loading data...
    </div>
  </div>

  <!-- <h2 class="text-xl font-bold mb-2">Raw data</h2> -->
  <!-- <div id="data">Loading data...</div> -->

  <script>
    let countdown = 60;

    function updateCountdown() {
      document.getElementById("nextUpdate").textContent = `Next update in ${countdown}s`;
    }

    function tickCountdown() {
      if (countdown > 0) {
        countdown--;
        updateCountdown();
      }
    }

    function formatTimestamp(ts) {
      let date;
      if (!isNaN(ts)) {
        const num = Number(ts);
        date = new Date(num < 1e12 ? num * 1000 : num);
      } else {
        date = new Date(ts);
      }
      return dateFns.format(date, "yyyy-MM-dd HH:mm:ss");
    }

    function formatRelative(ts) {
      let date;
      if (!isNaN(ts)) {
        const num = Number(ts);
        date = new Date(num < 1e12 ? num * 1000 : num);
      } else {
        date = new Date(ts);
      }
      return dateFns.formatDistanceToNow(date, { addSuffix: true });
    }

    let requestsChart;
    function initChart() {
      const chartDom = document.getElementById("requestsChart");
      requestsChart = echarts.init(chartDom);
    }
    function updateChart(metrics) {
      if (!requestsChart) {
        initChart();
      }
      const times = metrics.map(m => dateFns.format(new Date(m.timestamp), "HH:mm"));
      const counts = metrics.map(m => m.requests_count);

      const option = {
        tooltip: { trigger: "axis" },
        grid: {
          left: '0%',
          right: '0%',
          top: '8%',
          bottom: '10%',
          containLabel: true,
        },
        xAxis: {
          type: "category",
          data: times,
          boundaryGap: true,
          axisLabel: { rotate: 45 }
        },
        yAxis: {
          type: 'value',
          min: 0,
          max: (val) => Math.ceil(val.max / 10) * 10 + 10,
          interval: 10,
        },
        series: [
          {
            name: "Requests per Minute",
            type: "bar",
            data: counts,
            itemStyle: {
              color: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                  { offset: 0, color: '#3399ff' },
                  { offset: 1, color: '#66ccff' }
                ]
              }
            },
            barCategoryGap: '10%',
          }
        ]
      };
      requestsChart.setOption(option);
      requestsChart.resize();
    }

    async function loadData() {
      try {
        const response = await fetch("data.json", { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const json = await response.json();

        countdown = 60;
        updateCountdown();

        document.getElementById("data").textContent = JSON.stringify(json, null, 2);

        document.getElementById("totalRequests").textContent = json.total_requests ?? "--";
        document.getElementById("requestsLastMinute").textContent = json.requests_last_minute ?? "--";
        document.getElementById("workersCount").textContent = json.workers?.length ?? 0;

        const workersTable = document.getElementById("workersTable");
        workersTable.innerHTML = "";

        if (json.workers && json.workers.length > 0) {
          json.workers.forEach((worker, index) => {
            const row = document.createElement("tr");

            const isLast = index === json.workers.length - 1;
            row.className = isLast ? "" : "border-b border-slate-200";

            row.innerHTML = `
              <td class="px-4 py-2">
                <span class="inline-block w-3 h-3 bg-green-500 rounded-full"></span>
              </td>
              <td class="px-4 py-2 font-mono">${worker.container_id}</td>
              <td class="px-4 py-2">${formatTimestamp(worker.start_time)}</td>
              <td class="px-4 py-2 text-gray-600">${formatRelative(worker.start_time)}</td>
            `;
            workersTable.appendChild(row);
          });
        } else {
          workersTable.innerHTML = `
            <tr>
              <td colspan="4" class="px-4 py-2 text-gray-500 text-center">No workers</td>
            </tr>
          `;
        }

        if (json.requests_metrics) {
          updateChart(json.requests_metrics);
        }
      } catch (err) {
        document.getElementById("data").textContent = "Error loading data: " + err;
      }
    }

    loadData();
    
    setInterval(loadData, 60000);
    setInterval(tickCountdown, 1000);
    window.addEventListener("resize", () => {
      if (requestsChart) requestsChart.resize();
    });

    const toggleRawBtn = document.getElementById("toggleRaw");
    const dataBox = document.getElementById("data");

    toggleRawBtn.addEventListener("click", () => {
      const isHidden = dataBox.classList.contains("hidden");
      if (isHidden) {
        dataBox.classList.remove("hidden");
        toggleRawBtn.textContent = "Hide raw data";
      } else {
        dataBox.classList.add("hidden");
        toggleRawBtn.textContent = "Show raw data";
      }
    });
  </script>
</body>
</html>